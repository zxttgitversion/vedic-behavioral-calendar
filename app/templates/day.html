<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Day Detail</title>
  <style>
    :root {
      --bg: #f4f7fc;
      --card: #ffffff;
      --text: #162335;
      --muted: #5f6f85;
      --line: #dbe5f2;
      --green: #1f8f5f;
      --yellow: #b98600;
      --red: #bf3434;
      --accent: #1f4d9f;
      --guidance-bg: #f8faff;
      --guidance-line: #d8e5fb;
      --delta-soft: #a0a0a0;
      --inward: #3498db;
      --outward: #f1c40f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans SC", Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #eaf1fc 0%, var(--bg) 36%, #f8fbff 100%);
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .title { margin: 0; font-size: 30px; }
    .sub { margin: 8px 0 16px; color: var(--muted); }
    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .kpi, .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    .kpi { padding: 12px; }
    .kpi .k { color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .kpi .v { font-size: 24px; font-weight: 700; }
    .signal-green { color: var(--green); }
    .signal-yellow { color: var(--yellow); }
    .signal-red { color: var(--red); }
    .card { padding: 14px; margin-bottom: 10px; }
    .card h3 { margin: 0 0 10px; font-size: 18px; }
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .meta {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fbfdff;
    }
    .meta .k { color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .meta .v { font-weight: 600; }
    .warn {
      background: #fff7e8;
      border: 1px solid #f1d299;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .warn b { color: #9d5c00; }

    .guidance {
      background: var(--guidance-bg);
      border: 1px solid var(--guidance-line);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .guidance-title {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 700;
    }
    .guidance-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .guidance-box {
      background: #eaf1fc;
      border: 1px solid #d8e4f9;
      border-radius: 10px;
      padding: 10px;
      min-height: 92px;
    }
    .guidance-box .k { font-size: 12px; color: var(--muted); margin-bottom: 5px; }
    .guidance-box .v { line-height: 1.55; font-size: 15px; }

    .dims-group-note {
      font-size: 14px;
      font-weight: 600;
      color: #5c6b80;
      margin: 2px 0 6px;
      letter-spacing: 0.2px;
    }
    .dims-divider { height: 8px; }
    .dim-bars { display: grid; gap: 10px; }
    .dim-row {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fbfdff;
      overflow: hidden;
    }
    .dim-row-top {
      display: grid;
      grid-template-columns: 220px 1fr 130px;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }
    .dim-name {
      font-size: 16px;
      font-weight: 700;
      color: #152033;
      min-width: 0;
      overflow-wrap: anywhere;
    }
    .dim-bar-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #e8effb;
      overflow: hidden;
      min-width: 0;
    }
    .dim-bar-fill { height: 12px; border-radius: 999px; }
    .fill-inner { background: linear-gradient(90deg, #4f9de2 0%, var(--inward) 100%); }
    .fill-outer { background: linear-gradient(90deg, #f5d268 0%, var(--outward) 100%); }
    .dim-score {
      text-align: right;
      display: inline-flex;
      align-items: flex-end;
      justify-content: flex-end;
      gap: 3px;
      white-space: nowrap;
      margin-right: 20px;
    }
    .main-score {
      font-size: 18px;
      font-weight: 700;
    }
    .delta-soft {
      font-weight: 400;
      font-size: 11px;
      opacity: 0.6;
      align-self: flex-start;
      line-height: 1;
      margin-top: 2px;
      vertical-align: super;
    }
    .delta-pos {
      color: #27ae60;
    }
    .delta-neg {
      color: #e74c3c;
    }
    .delta-zero {
      color: var(--delta-soft);
    }
    .driver-line {
      font-size: 12px;
      font-weight: 400;
      color: #7f8c8d;
      margin-top: 4px;
      line-height: 1.45;
      overflow-wrap: anywhere;
    }
    .glossary {
      margin-top: 8px;
      color: #8a95a8;
      font-size: 12px;
      font-style: italic;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    @media (max-width: 920px) {
      .kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .meta-grid { grid-template-columns: 1fr; }
      .guidance-grid { grid-template-columns: 1fr; }
      .dim-row-top { grid-template-columns: 1fr; }
      .dim-score { text-align: left; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Daily Astro Card v2.2</h1>
    <p class="sub">Bilingual UI with integrated drivers</p>

    <div class="kpis">
      <div class="kpi">
        <div class="k">Date</div>
        <div class="v">{{ day["date"] }}</div>
      </div>
      <div class="kpi">
        <div class="k">Signal</div>
        <div class="v signal-{{ day['signal'] }}">{{ day["signal"]|capitalize }}</div>
      </div>
      <div class="kpi">
        <div class="k">Total Index</div>
        <div class="v">{{ day["scores"]["total_index"] }}</div>
      </div>
      <div class="kpi">
        <div class="k">Dasha</div>
        <div class="v" style="font-size:20px">{{ day["user_profile"]["dasha_period"] }}</div>
      </div>
    </div>

    <div class="guidance">
      <p class="guidance-title">Master's Guidance (å¤§å¸ˆæŒ‡å¼•)</p>
      <div class="guidance-grid">
        <div class="guidance-box">
          <div class="k">Summary (ä»Šæ—¥è¿åŠ¿æ€»ç»“)</div>
          <div class="v">
            {% if day.get("summary_llm") %}
              [Bilingual Placeholder]
            {% else %}
              [Bilingual Placeholder]
            {% endif %}
          </div>
        </div>
        <div class="guidance-box">
          <div class="k">Actions (è¡ŒåŠ¨å»ºè®®)</div>
          <div class="v">
            [Bilingual Placeholder]<br>
            å»ºè®®è¡ŒåŠ¨ (Do):<br>
            å»ºè®®å›é¿ (Avoid):
          </div>
        </div>
      </div>
    </div>

    {% if day["astrological_triggers"]["obstruction"]["has_obstruction"] %}
      <div class="warn">
        <b>âš  å¥½è¿å—é˜» (Obstruction/Vedha)</b><br>
        {{ day["astrological_triggers"]["obstruction"]["message"] }}
      </div>
    {% endif %}

    {% set titles = day["components"].get("module_titles", {}) %}
    {% set fields = day["components"].get("field_labels", {}) %}

    <div class="card">
      <h3>{{ titles.get("core_context", "æ ¸å¿ƒæ˜Ÿè±¡èƒŒæ™¯ (Core Context)") }}</h3>
      <div class="meta-grid">
        <div class="meta">
          <div class="k">{{ fields.get("lagna", "ä¸Šå‡æ˜Ÿåº§ (Lagna)") }}</div>
          <div class="v">{{ day["user_profile"].get("lagna_display", day["user_profile"]["lagna"]) }}</div>
        </div>
        <div class="meta">
          <div class="k">{{ fields.get("natal_moon_rasi", "æœ¬å‘½æœˆäº®æ˜Ÿåº§ (Chandra Lagna)") }}</div>
          <div class="v">{{ day["user_profile"].get("natal_moon_rasi_display", day["user_profile"]["natal_moon_rasi"]) }}</div>
        </div>
        <div class="meta">
          <div class="k">{{ fields.get("dasha_relationship", "å¤§è¿å…³ç³» (Dasha Relationship)") }}</div>
          <div class="v">{{ day["user_profile"]["dasha_relationship"] }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>{{ titles.get("tara_bala", "æ˜Ÿå®¿èƒ½é‡åŒ¹é… (Tara Bala)") }}</h3>
      <div class="meta-grid">
        <div class="meta">
          <div class="k">{{ fields.get("natal_nakshatra", "æœ¬å‘½æ˜Ÿå®¿") }}</div>
          <div class="v">{{ day["components"].get("natal_nakshatra_display", day["components"]["natal_nakshatra"]) }}</div>
        </div>
        <div class="meta">
          <div class="k">{{ fields.get("transit_nakshatra", "ä»Šæ—¥è¿è¡Œæ˜Ÿå®¿") }}</div>
          <div class="v">{{ day["components"].get("transit_nakshatra_display", day["components"]["transit_nakshatra"]) }}</div>
        </div>
        <div class="meta">
          <div class="k">{{ fields.get("tara_label", "èƒ½é‡æ€§è´¨") }}</div>
          <div class="v">{{ day["components"].get("tara_label_display", day["astrological_triggers"]["tara_bala"]["name"]) }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>äº”ç»´å¾—åˆ† (Score + Delta)</h3>

      {% set inward_dims = ["emotion", "vitality"] %}
      {% set outward_dims = ["career", "wealth", "social"] %}

      <div class="dims-group-note">Inward Energy (å¯¹å†…èƒ½é‡)</div>
      <div class="dim-bars">
        {% for k in inward_dims %}
          {% set v = day["scores"]["dimensions"].get(k, 0) %}
          {% set lbl = day["components"]["dimension_labels"].get(k, {}) %}
          {% set en = lbl.get("en", k) %}
          {% set zh = lbl.get("zh", k) %}
          {% set delta = day["scores"].get("deltas", {}).get(k, 0) %}
          <div class="dim-row">
            <div class="dim-row-top">
              <div class="dim-name">{{ zh }} ({{ en }})</div>
              <div class="dim-bar-track"><div class="dim-bar-fill fill-inner" style="width: {{ v }}%;"></div></div>
              {% set delta_class = "delta-zero" %}
              {% if delta > 0 %}{% set delta_class = "delta-pos" %}{% elif delta < 0 %}{% set delta_class = "delta-neg" %}{% endif %}
              <div class="dim-score"><span class="delta-soft {{ delta_class }}">{{ "%+d"|format(delta) }}</span><span class="main-score">{{ v }}</span></div>
            </div>
            {% for x in day["astrological_triggers"]["key_transits"] %}
              {% if x["dimension"] == k %}
                <div class="driver-line">
                  é©±åŠ¨å› å­ï¼š{{ x.get("planet_display", x["planet_zh"]) }} | Lagna {{ x["lagna_house_label"] }} | Chandra {{ x["chandra_house_label"] }} | {{ x["status_label"] }}
                  {% if x["vedha"]["is_obstructed"] %}
                    | ğŸ›‘ è¢«{{ x["vedha"].get("obstructor_zh", x["vedha"]["obstructor"]) }}é˜»ç¢ (Vedha)
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <div class="dims-divider"></div>
      <div class="dims-group-note">Outward Energy (å¯¹å¤–èƒ½é‡)</div>
      <div class="dim-bars">
        {% for k in outward_dims %}
          {% set v = day["scores"]["dimensions"].get(k, 0) %}
          {% set lbl = day["components"]["dimension_labels"].get(k, {}) %}
          {% set en = lbl.get("en", k) %}
          {% set zh = lbl.get("zh", k) %}
          {% set delta = day["scores"].get("deltas", {}).get(k, 0) %}
          <div class="dim-row">
            <div class="dim-row-top">
              <div class="dim-name">{{ zh }} ({{ en }})</div>
              <div class="dim-bar-track"><div class="dim-bar-fill fill-outer" style="width: {{ v }}%;"></div></div>
              {% set delta_class = "delta-zero" %}
              {% if delta > 0 %}{% set delta_class = "delta-pos" %}{% elif delta < 0 %}{% set delta_class = "delta-neg" %}{% endif %}
              <div class="dim-score"><span class="delta-soft {{ delta_class }}">{{ "%+d"|format(delta) }}</span><span class="main-score">{{ v }}</span></div>
            </div>
            {% for x in day["astrological_triggers"]["key_transits"] %}
              {% if x["dimension"] == k %}
                <div class="driver-line">
                  é©±åŠ¨å› å­ï¼š{{ x.get("planet_display", x["planet_zh"]) }} | Lagna {{ x["lagna_house_label"] }} | Chandra {{ x["chandra_house_label"] }} | {{ x["status_label"] }}
                  {% if x["vedha"]["is_obstructed"] %}
                    | ğŸ›‘ è¢«{{ x["vedha"].get("obstructor_zh", x["vedha"]["obstructor"]) }}é˜»ç¢ (Vedha)
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <div class="glossary">* Vedha (é˜»ç¢)ï¼šå°åº¦å æ˜Ÿç‰¹æœ‰æ¦‚å¿µï¼ŒæŒ‡å½“å‰è¡Œæ˜Ÿçš„å¥½è¿èƒ½é‡è¢«å¦ä¸€é¢—å¤„äºç‰¹å®šä½ç½®çš„è¡Œæ˜Ÿç‰©ç†æ€§å±è”½ã€‚</div>
    </div>

    <div style="margin-top:14px">
      <a href="/calendar/{{ file_id }}">Back to Calendar</a>
    </div>
  </div>
</body>
</html>
